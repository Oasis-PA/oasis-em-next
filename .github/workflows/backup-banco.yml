name: ğŸ’¾ Backup AutomÃ¡tico do Banco

# Acionadores
on:
  push:
    branches:
      - main
      - apresentacao-tcc
    # Ignorar commits que apenas atualizem documentaÃ§Ã£o
    paths-ignore:
      - "docs/**"
      - "README.md"
      - "CHANGELOG.md"
  schedule:
    # Executar backup diariamente Ã s 2 da manhÃ£ (UTC)
    - cron: "0 2 * * *"
  workflow_dispatch:
    # Permite acionamento manual via GitHub UI

# VariÃ¡veis de ambiente
env:
  NODE_VERSION: "20"
  BACKUP_DIR: "backups"

jobs:
  backup:
    name: ğŸ“¦ Executar Backup do Banco
    runs-on: ubuntu-latest

    # PermissÃµes necessÃ¡rias
    permissions:
      contents: write
      actions: read

    steps:
      # 1. Fazer checkout do cÃ³digo
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Configurar Node.js
      - name: ğŸ”§ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # 3. Instalar dependÃªncias
      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci
        continue-on-error: true

      # 4. Verificar variÃ¡veis de ambiente
      - name: ğŸ” Verificar variÃ¡veis de ambiente
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ DATABASE_URL nÃ£o estÃ¡ configurada!"
            exit 1
          fi
          echo "âœ… DATABASE_URL configurada"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # 5. Executar backup
      - name: ğŸ’¾ Executar backup do banco de dados
        run: npm run backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

      # 6. Verificar se backup foi criado
      - name: ğŸ” Verificar arquivo de backup
        run: |
          if [ -f "$(ls -t backups/backup-*.json | head -1)" ]; then
            echo "âœ… Backup criado com sucesso!"
            ls -lh backups/backup-*.json | head -5
          else
            echo "âš ï¸ Nenhum backup encontrado"
          fi

      # 7. Configurar Git para commit automÃ¡tico
      - name: âš™ï¸ Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 8. Adicionar backup ao Git
      - name: ğŸ“ Adicionar arquivo de backup ao Git
        run: |
          if [ -n "$(git status --porcelain backups/)" ]; then
            git add backups/
            echo "âœ… Arquivo de backup adicionado"
          else
            echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o nos backups"
          fi

      # 9. Fazer commit do backup
      - name: ğŸ”— Fazer commit do backup
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "backup: Novo backup automÃ¡tico - $(date +'%Y-%m-%d %H:%M:%S UTC')" \
              -m "Este backup foi gerado automaticamente pelo GitHub Actions" \
              -m "Triggers: push para main/apresentacao-tcc, ou schedule diÃ¡rio" \
              --no-verify
            echo "âœ… Commit criado com sucesso"
          else
            echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o para commitar"
          fi

      # 10. Fazer push do backup para o repositÃ³rio
      - name: ğŸš€ Push do backup para o repositÃ³rio
        run: |
          if [ -n "$(git log --oneline -1 --format='%s' | grep -i backup)" ]; then
            git push origin main
            echo "âœ… Backup enviado para o repositÃ³rio"
          else
            echo "â„¹ï¸ Nenhum backup novo para enviar"
          fi
        continue-on-error: true

      # 11. Notificar sucesso
      - name: âœ… Backup concluÃ­do com sucesso
        if: success()
        run: echo "ğŸ‰ Backup automÃ¡tico executado com sucesso!"

      # 12. Notificar erro
      - name: âŒ Notificar erro
        if: failure()
        run: echo "âš ï¸ Houve um erro durante o backup. Verifique os logs acima."
