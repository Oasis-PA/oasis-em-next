# üîç An√°lise de Gaps - Sistema Oasis

An√°lise detalhada de funcionalidades faltantes, problemas identificados e inconsist√™ncias no projeto.

**Data da An√°lise:** 2025-10-29
**Vers√£o do Projeto:** 0.9
**Analisado por:** Claude Code

---

## üìã √çndice

1. [Gaps de APIs](#-gaps-de-apis)
2. [Gaps de Seguran√ßa](#-gaps-de-seguran√ßa)
3. [Gaps de Valida√ß√£o](#-gaps-de-valida√ß√£o)
4. [Gaps de Frontend](#-gaps-de-frontend)
5. [Gaps de DevOps](#-gaps-de-devops)
6. [Gaps de Documenta√ß√£o](#-gaps-de-documenta√ß√£o)
7. [Gaps de Testes](#-gaps-de-testes)
8. [Gaps de Performance](#-gaps-de-performance)

---

## üîå Gaps de APIs

### 1. Sistema de Avalia√ß√µes (Reviews)

**Modelo existe no Prisma, mas APIs n√£o implementadas.**

#### Modelo Prisma:
```prisma
model Avaliacao {
  id_avaliacao   Int      @id @default(autoincrement())
  nota           Int
  comentario     String?
  data_avaliacao DateTime @default(now())
  id_usuario     Int
  id_produto     Int
  produto        Produto  @relation(fields: [id_produto], references: [id_produto])
  usuario        Usuario  @relation(fields: [id_usuario], references: [id_usuario])
}
```

#### Endpoints Faltando:
```
‚ùå POST   /api/produtos/[id]/avaliacoes      - Criar avalia√ß√£o
‚ùå GET    /api/produtos/[id]/avaliacoes      - Listar avalia√ß√µes de um produto
‚ùå GET    /api/usuarios/[id]/avaliacoes      - Listar avalia√ß√µes de um usu√°rio
‚ùå DELETE /api/avaliacoes/[id]               - Deletar avalia√ß√£o
‚ùå PATCH  /api/avaliacoes/[id]               - Editar avalia√ß√£o
‚ùå GET    /api/produtos/[id]/avaliacoes/media - Calcular m√©dia de avalia√ß√µes
```

#### Impacto:
- **Alto** - Feature essencial para e-commerce
- Usu√°rios n√£o conseguem avaliar produtos
- Sem valida√ß√£o social dos produtos
- Modelo existe mas inutilizado

#### Solu√ß√£o Sugerida:
```typescript
// src/app/api/produtos/[id]/avaliacoes/route.ts
export async function POST(req: Request, { params }: { params: { id: string } }) {
  const { nota, comentario } = await req.json();
  const userId = await getUserIdFromToken(req);

  // Validar que usu√°rio n√£o avaliou antes
  const existente = await prisma.avaliacao.findFirst({
    where: { id_usuario: userId, id_produto: parseInt(params.id) }
  });

  if (existente) {
    return NextResponse.json(
      { error: 'Voc√™ j√° avaliou este produto' },
      { status: 400 }
    );
  }

  const avaliacao = await prisma.avaliacao.create({
    data: {
      nota,
      comentario,
      id_usuario: userId,
      id_produto: parseInt(params.id)
    }
  });

  return NextResponse.json(avaliacao);
}
```

---

### 2. Sistema de M√∫ltiplas Imagens

**Modelo existe, mas sem CRUD individual.**

#### Modelo Prisma:
```prisma
model ImagemProduto {
  id_imagem_produto Int     @id @default(autoincrement())
  id_produto        Int
  url_imagem        String
  ordem             Int?
  Produto           Produto @relation(fields: [id_produto], references: [id_produto], onDelete: Cascade)
}
```

#### Endpoints Faltando:
```
‚ùå POST   /api/produtos/[id]/imagens         - Upload m√∫ltiplas imagens
‚ùå GET    /api/produtos/[id]/imagens         - Listar imagens do produto
‚ùå DELETE /api/imagens/[id]                  - Deletar imagem espec√≠fica
‚ùå PATCH  /api/imagens/[id]/ordem            - Reordenar imagens
‚ùå PATCH  /api/produtos/[id]/imagem-principal - Definir imagem principal
```

#### Problema Atual:
```typescript
// src/app/api/produtos/cadastro/route.ts:46
url_imagem: validatedData.url_imagem || null,
// Apenas 1 URL de imagem √© suportada
```

#### Impacto:
- **M√©dio** - Produtos limitados a 1 imagem
- UX prejudicada (sem galeria)
- Campo `ordem` no banco n√£o √© utilizado

---

### 3. PATCH Endpoints (Atualiza√ß√£o Parcial)

**Apenas POST e DELETE implementados, sem atualiza√ß√£o parcial.**

#### Endpoints Faltando:
```
‚ùå PATCH /api/produtos/[id]         - Atualizar produto
‚ùå PATCH /api/categorias/[id]       - Atualizar categoria
‚ùå PATCH /api/tags/[id]             - Atualizar tag
‚ùå PATCH /api/artigos/[id]          - Atualizar artigo (admin)
‚ùå PATCH /api/usuarios/[id]         - Atualizar usu√°rio espec√≠fico
```

#### Problema Atual:
```typescript
// src/app/api/usuarios/update/route.ts
// Usa PATCH mas exige todos os campos
const validatedData = updateUsuarioSchema.parse(body);
// Se faltar algum campo, d√° erro
```

#### Impacto:
- **M√©dio** - Imposs√≠vel atualizar apenas 1 campo
- Frontend precisa enviar todos os dados
- Risco de sobrescrever dados n√£o intencionalmente

#### Solu√ß√£o Sugerida:
```typescript
// Schema parcial para PATCH
const updateProdutoPartialSchema = ProdutoSchema.partial();

export async function PATCH(req: Request, { params }: { params: { id: string } }) {
  const body = await req.json();
  const validatedData = updateProdutoPartialSchema.parse(body);

  const produto = await prisma.produto.update({
    where: { id_produto: parseInt(params.id) },
    data: validatedData // Apenas campos enviados
  });

  return NextResponse.json(produto);
}
```

---

### 4. Endpoints Admin Incompletos

#### Faltando:
```
‚ùå GET    /api/admin/usuarios                - Listar usu√°rios
‚ùå DELETE /api/admin/usuarios/[id]           - Deletar usu√°rio
‚ùå PATCH  /api/admin/usuarios/[id]           - Atualizar usu√°rio
‚ùå GET    /api/admin/produtos                - Listar produtos (admin)
‚ùå DELETE /api/admin/produtos/[id]           - Deletar produto
‚ùå GET    /api/admin/avaliacoes              - Moderar avalia√ß√µes
‚ùå DELETE /api/admin/avaliacoes/[id]         - Deletar avalia√ß√£o
‚ùå GET    /api/admin/stats                   - Dashboard stats
```

#### Impacto:
- **M√©dio** - Admin n√£o consegue gerenciar totalmente o sistema
- Sem modera√ß√£o de conte√∫do
- Sem analytics/m√©tricas

---

## üîê Gaps de Seguran√ßa

### 1. Admin Auth com Token Fraco

**Severidade: üî¥ CR√çTICA**

#### C√≥digo Problem√°tico:
```typescript
// src/app/api/admin/auth/route.ts:14-15
const token = Buffer.from(`${username}:${Date.now()}`).toString('base64');

// Exemplo de token gerado:
// "YWRtaW46MTczMDIxMjQ1NjAwMA==" (decodific√°vel!)
```

#### Problema:
- Token √© apenas Base64, **n√£o criptografado**
- Qualquer um pode decodificar: `atob("YWRtaW46MTczMDIxMjQ1NjAwMA==")`
- Sem assinatura/valida√ß√£o
- Vulner√°vel a replay attacks

#### Solu√ß√£o:
```typescript
import jwt from 'jsonwebtoken';

const token = jwt.sign(
  { username, role: 'admin' },
  process.env.ADMIN_JWT_SECRET!,
  { expiresIn: '1h' }
);
```

---

### 2. Sem Rate Limiting

**Severidade: üî¥ CR√çTICA**

#### Endpoints Vulner√°veis:
```
/api/usuarios/login          - For√ßa bruta de senha
/api/usuarios/cadastro       - Spam de contas
/api/usuarios/check-email    - Enumera√ß√£o de usu√°rios
/api/usuarios/esqueceusenha  - Spam de emails
```

#### Ataque Poss√≠vel:
```bash
# For√ßa bruta sem rate limiting
for i in {1..10000}; do
  curl -X POST /api/usuarios/login \
    -d '{"email":"admin@site.com","senha":"tentativa'$i'"}'
done
```

#### Impacto:
- Ataques de for√ßa bruta ilimitados
- DDoS simples
- Enumera√ß√£o de usu√°rios
- Spam de emails de recupera√ß√£o

#### Solu√ß√£o:
```typescript
import { Ratelimit } from '@upstash/ratelimit';

const ratelimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(5, '15 m'), // 5 req/15min
});

export async function POST(req: Request) {
  const ip = req.headers.get('x-forwarded-for') || 'unknown';
  const { success } = await ratelimit.limit(ip);

  if (!success) {
    return NextResponse.json(
      { error: 'Muitas tentativas. Tente novamente em 15 minutos.' },
      { status: 429 }
    );
  }

  // ... resto do c√≥digo
}
```

---

### 3. Credenciais Padr√£o Fracas

**Severidade: üü° ALTA**

#### C√≥digo Problem√°tico:
```typescript
// src/app/api/admin/auth/route.ts:4-5
const ADMIN_USER = process.env.ADMIN_USERNAME || 'admin';
const ADMIN_PASS = process.env.ADMIN_PASSWORD || 'admin123';
```

#### Problema:
- Se `.env` n√£o configurado, usa 'admin/admin123'
- Credenciais fracas em fallback
- Facilita ataques em dev/staging

#### Solu√ß√£o:
```typescript
const ADMIN_USER = process.env.ADMIN_USERNAME;
const ADMIN_PASS = process.env.ADMIN_PASSWORD;

if (!ADMIN_USER || !ADMIN_PASS) {
  throw new Error('ADMIN_USERNAME e ADMIN_PASSWORD devem ser configurados no .env');
}
```

---

### 4. Supabase Service Role Key Exposta

**Severidade: üü° ALTA**

#### Problema:
```typescript
// src/app/api/usuarios/upload-foto/route.ts
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // ‚ö†Ô∏è Chave privilegiada
);
```

#### Risco:
- Service Role key bypass RLS (Row Level Security)
- Se exposta, permite acesso total ao banco
- N√£o deve estar em rotas p√∫blicas

#### Solu√ß√£o:
```typescript
// Usar client-side com RLS
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! // ‚úÖ Chave p√∫blica
);

// Service Role apenas em server actions
'use server';
const supabaseAdmin = createClient(...);
```

---

### 5. Sem Security Headers

**Severidade: üü† M√âDIA**

#### Headers Faltando:
```
‚ùå X-Frame-Options          - Prote√ß√£o contra clickjacking
‚ùå Content-Security-Policy  - Prote√ß√£o contra XSS
‚ùå X-Content-Type-Options   - Prote√ß√£o contra MIME sniffing
‚ùå Referrer-Policy          - Controle de referrer
‚ùå Permissions-Policy       - Controle de features do browser
```

#### Solu√ß√£o:
```typescript
// next.config.ts
export default {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'X-XSS-Protection', value: '1; mode=block' },
        ],
      },
    ];
  },
};
```

---

## ‚úÖ Gaps de Valida√ß√£o

### 1. Valida√ß√£o de Pre√ßo

**Severidade: üü† M√âDIA**

#### Problema Atual:
```typescript
// src/lib/zod-schemas/produto.ts
preco: z.number()
// Aceita qualquer n√∫mero (negativo, infinito, NaN)
```

#### Testes que Passariam:
```typescript
{ preco: -100 }      // ‚úÖ Aceito (errado!)
{ preco: Infinity }  // ‚úÖ Aceito (errado!)
{ preco: 0 }         // ‚úÖ Aceito (pode ser v√°lido ou n√£o)
```

#### Solu√ß√£o:
```typescript
preco: z.number()
  .min(0.01, 'Pre√ßo deve ser maior que zero')
  .max(999999.99, 'Pre√ßo muito alto')
  .finite('Pre√ßo deve ser um n√∫mero finito')
```

---

### 2. Valida√ß√£o de URL

**Severidade: üü† M√âDIA**

#### Problema Atual:
```typescript
url_imagem: z.string().optional()
// Aceita qualquer string como URL
```

#### Testes que Passariam:
```typescript
{ url_imagem: 'n√£o √© uma url' }     // ‚úÖ Aceito (errado!)
{ url_imagem: 'javascript:alert()' } // ‚úÖ Aceito (XSS!)
```

#### Solu√ß√£o:
```typescript
url_imagem: z.string()
  .url('URL inv√°lida')
  .regex(/^https?:\/\//, 'URL deve come√ßar com http:// ou https://')
  .optional()
```

---

### 3. Valida√ß√£o de Telefone

**Severidade: üü° BAIXA**

#### Problema Atual:
```typescript
telefone: z.string().optional()
// Aceita qualquer formato
```

#### Solu√ß√£o:
```typescript
telefone: z.string()
  .regex(/^\(\d{2}\)\s?\d{4,5}-\d{4}$/, 'Telefone inv√°lido. Use: (11) 91234-5678')
  .optional()
```

---

### 4. Valida√ß√£o de Tamanho de Upload

**Severidade: üü† M√âDIA**

#### Problema:
Sem limite de tamanho para uploads

#### Solu√ß√£o:
```typescript
// middleware.ts ou route
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

if (file.size > MAX_FILE_SIZE) {
  return NextResponse.json(
    { error: 'Arquivo muito grande. M√°ximo: 5MB' },
    { status: 413 }
  );
}
```

---

## üé® Gaps de Frontend

### 1. Componentes Reutiliz√°veis Limitados

**Problema:**
Apenas 8 componentes UI b√°sicos:
```
ui/
‚îú‚îÄ‚îÄ avatar.tsx
‚îú‚îÄ‚îÄ button.tsx
‚îî‚îÄ‚îÄ separator.tsx
```

#### Faltando:
```
‚ùå Input component
‚ùå Select component
‚ùå Form components
‚ùå Modal/Dialog
‚ùå Toast/Notification
‚ùå Card component
‚ùå Table component
‚ùå Loading/Spinner
‚ùå Error boundary
```

---

### 2. P√°ginas de Desenvolvimento N√£o Removidas

**Problema:**
P√°ginas de teste ainda no c√≥digo:

```
/pos-login-demo
/pre-pronto
/cadastrar-produto
/cadastrar-tag
/tela-produto
/pagina-em-manutencao
```

#### Impacto:
- Confus√£o em desenvolvimento
- Podem ser acessadas em produ√ß√£o
- Poluem a estrutura

---

### 3. Inconsist√™ncia de Layout

**Problema:**
M√∫ltiplos layouts para perfil:
```
/perfil/layout.tsx
/gerenciamento/layout.tsx
/meuperfil-before/page.tsx
/meuperfil-after/page.tsx
```

#### Solu√ß√£o:
Consolidar em um √∫nico layout e componentes reutiliz√°veis.

---

## üöÄ Gaps de DevOps

### 1. Sem CI/CD

**Severidade: üü† M√âDIA**

#### Faltando:
```
‚ùå .github/workflows/test.yml
‚ùå .github/workflows/lint.yml
‚ùå .github/workflows/build.yml
‚ùå .github/workflows/deploy.yml
```

#### Impacto:
- Sem valida√ß√£o autom√°tica de PRs
- Testes n√£o rodados automaticamente
- Deploy manual (propenso a erros)

---

### 2. Sem Docker

**Severidade: üü° BAIXA**

#### Faltando:
```
‚ùå Dockerfile
‚ùå docker-compose.yml
‚ùå .dockerignore
```

#### Impacto:
- Dificuldade em replicar ambiente
- Sem containeriza√ß√£o
- Deploy limitado

---

### 3. Sem Pre-commit Hooks

**Severidade: üü° BAIXA**

#### Faltando:
```
‚ùå .husky/pre-commit
‚ùå .husky/pre-push
‚ùå lint-staged config
```

#### Impacto:
- C√≥digo n√£o validado antes do commit
- Erros chegam ao reposit√≥rio
- CI/CD precisa fazer todo o trabalho

---

## üìö Gaps de Documenta√ß√£o

### 1. Sem Documenta√ß√£o de API (Swagger/OpenAPI)

**Severidade: üü† M√âDIA**

#### Faltando:
- Especifica√ß√£o OpenAPI/Swagger
- UI interativa de documenta√ß√£o
- Exemplos de request/response
- Schemas de valida√ß√£o documentados

#### Impacto:
- Dif√≠cil para frontend consumir APIs
- Sem contrato formal de API
- Dificulta integra√ß√£o futura

---

### 2. Sem Diagramas de Arquitetura

**Severidade: üü° BAIXA**

#### Faltando:
- ERD (Entity Relationship Diagram)
- Diagrama de arquitetura geral
- Fluxos de autentica√ß√£o
- Diagrama de deploy

---

### 3. Sem Guia de Deploy

**Severidade: üü° BAIXA**

#### Faltando:
- Passo a passo de deploy
- Configura√ß√£o de dom√≠nio
- Setup de vari√°veis de ambiente
- Troubleshooting de produ√ß√£o

---

## üß™ Gaps de Testes

### 1. Sem Testes E2E

**Severidade: üü† M√âDIA**

#### Faltando:
- Setup Playwright/Cypress
- Testes de fluxo completo
- Testes de interface

#### Impacto:
- Bugs podem passar para produ√ß√£o
- Sem valida√ß√£o de UX
- Regress√µes n√£o detectadas

---

### 2. Sem Testes de Componentes React

**Severidade: üü° BAIXA**

#### Faltando:
- Testes com React Testing Library
- Testes de hooks
- Testes de intera√ß√£o

---

### 3. Cobertura de Testes Limitada

**Atual:** ~60-70%
**Meta:** 80%+

#### √Åreas sem cobertura:
- Componentes React
- Error handling
- Edge cases

---

## ‚ö° Gaps de Performance

### 1. Sem Estrat√©gia de Cache

**Severidade: üü° BAIXA**

#### Faltando:
- Redis para cache de queries
- ISR (Incremental Static Regeneration)
- Cache de imagens

---

### 2. Imagens N√£o Otimizadas

**Severidade: üü° BAIXA**

#### Problemas:
- Uso de `<img>` em vez de `<Image>`
- Sem lazy loading
- Sem compress√£o autom√°tica
- Sem convers√£o para WebP

---

### 3. Sem Connection Pooling Expl√≠cito

**Severidade: üü† M√âDIA**

#### Problema:
Prisma usa pool padr√£o, mas sem otimiza√ß√£o

#### Solu√ß√£o:
```typescript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  // Adicionar
  connection_limit = 10
  pool_timeout     = 20
}
```

---

## üìä Resumo Executivo

### Por Severidade

| Severidade | Quantidade | Horas Est. |
|-----------|------------|------------|
| üî¥ Cr√≠tica | 2 gaps | 6h |
| üü° Alta | 3 gaps | 8h |
| üü† M√©dia | 12 gaps | 60h |
| üü¢ Baixa | 15 gaps | 45h |
| **TOTAL** | **32 gaps** | **119h** |

### Por Categoria

| Categoria | Gaps | Impacto |
|-----------|------|---------|
| APIs | 5 | Alto |
| Seguran√ßa | 5 | Cr√≠tico |
| Valida√ß√£o | 4 | M√©dio |
| Frontend | 3 | Baixo |
| DevOps | 3 | M√©dio |
| Documenta√ß√£o | 3 | Baixo |
| Testes | 3 | M√©dio |
| Performance | 3 | Baixo |

---

## üéØ Prioridades de Resolu√ß√£o

### Sprint 1 (Cr√≠tico - 14h)
1. Refatorar Admin Auth (4h)
2. Implementar Rate Limiting (2h)
3. Security Headers (1h)
4. Valida√ß√µes robustas (3h)
5. Remover credenciais padr√£o (1h)
6. Mover Supabase Service Role (3h)

### Sprint 2 (Alta Prioridade - 22h)
1. API de Avalia√ß√µes (8h)
2. PATCH endpoints (4h)
3. M√∫ltiplas imagens (6h)
4. Valida√ß√µes adicionais (4h)

### Sprint 3+ (M√©dio/Baixo - 83h)
Resolver gradualmente conforme necessidade do TCC.

---

**√öltima atualiza√ß√£o:** 2025-10-29
**Pr√≥xima an√°lise:** Ap√≥s Sprint 1 (2 semanas)
