# Guia de Testes de Integra√ß√£o - Sistema Oasis

## üìã Vis√£o Geral

Os testes de integra√ß√£o do sistema Oasis validam opera√ß√µes completas com **banco de dados real**, incluindo:

- ‚úÖ **Transa√ß√µes de banco de dados**
- ‚úÖ **Constraints de unicidade** (emails duplicados, slugs duplicados)
- ‚úÖ **Relacionamentos entre tabelas** (One-to-Many, Many-to-Many)
- ‚úÖ **Opera√ß√µes CASCADE** (dele√ß√£o em cascata)
- ‚úÖ **Integridade referencial** (foreign keys)

---

## üöÄ Execu√ß√£o R√°pida

```bash
# 1. Configurar banco de dados de teste (primeira vez)
npm run test:integration:setup

# 2. Executar todos os testes de integra√ß√£o
npm run test:integration

# 3. Executar testes espec√≠ficos
npm run test:integration -- usuarios.integration.test.ts
npm run test:integration -- produtos.integration.test.ts
npm run test:integration -- artigos.integration.test.ts
npm run test:integration -- relacionamentos.integration.test.ts
```

---

## üóÇÔ∏è Estrutura dos Testes

```
tests/integration/
‚îú‚îÄ‚îÄ setup.ts                           # Configura√ß√£o global (beforeAll, afterAll)
‚îú‚îÄ‚îÄ usuarios.integration.test.ts       # Testes de usu√°rios (19 testes)
‚îú‚îÄ‚îÄ produtos.integration.test.ts       # Testes de produtos (18 testes)
‚îú‚îÄ‚îÄ artigos.integration.test.ts        # Testes de artigos (16 testes)
‚îî‚îÄ‚îÄ relacionamentos.integration.test.ts # Testes de relacionamentos e cascades (15 testes)

Total: 68 testes de integra√ß√£o
```

---

## üìä Cobertura de Testes

### 1. Testes de Usu√°rios (19 testes)

#### Cria√ß√£o de Usu√°rio (3 testes)
- ‚úÖ Criar usu√°rio com sucesso
- ‚úÖ Rejeitar email duplicado (constraint √∫nico)
- ‚úÖ Criar usu√°rio com todos os campos opcionais

#### Leitura de Usu√°rio (3 testes)
- ‚úÖ Buscar usu√°rio por email
- ‚úÖ Buscar usu√°rio com relacionamentos (g√™nero, tipo de cabelo)
- ‚úÖ Retornar null ao buscar usu√°rio inexistente

#### Atualiza√ß√£o de Usu√°rio (3 testes)
- ‚úÖ Atualizar dados pessoais
- ‚úÖ Alterar senha
- ‚úÖ Rejeitar atualiza√ß√£o para email duplicado

#### Dele√ß√£o de Usu√°rio (2 testes)
- ‚úÖ Deletar usu√°rio
- ‚úÖ Deletar usu√°rio e tokens de reset em cascade

#### Transa√ß√µes de Usu√°rio (2 testes)
- ‚úÖ Fazer rollback de transa√ß√£o ao falhar
- ‚úÖ Criar usu√°rio e perfil em transa√ß√£o at√¥mica

---

### 2. Testes de Produtos (18 testes)

#### Cria√ß√£o de Produto (4 testes)
- ‚úÖ Criar produto com sucesso
- ‚úÖ Criar produto com relacionamentos (categoria, tag, tipo de cabelo)
- ‚úÖ Criar produto com m√∫ltiplas imagens
- ‚úÖ Rejeitar cria√ß√£o sem categoria (constraint NOT NULL)

#### Leitura de Produtos (4 testes)
- ‚úÖ Listar produtos com pagina√ß√£o
- ‚úÖ Filtrar produtos por categoria
- ‚úÖ Filtrar produtos por m√∫ltiplos crit√©rios
- ‚úÖ Buscar produtos por marca (case insensitive)

#### Atualiza√ß√£o de Produto (2 testes)
- ‚úÖ Atualizar dados do produto
- ‚úÖ Atualizar apenas pre√ßo (atualiza√ß√£o parcial)

#### Dele√ß√£o de Produto (3 testes)
- ‚úÖ Deletar produto
- ‚úÖ Deletar produto e suas imagens em cascade
- ‚úÖ Deletar produto e seus favoritos em cascade

#### Relacionamentos de Produto (2 testes)
- ‚úÖ Criar produto com avalia√ß√µes
- ‚úÖ Calcular m√©dia de avalia√ß√µes

---

### 3. Testes de Artigos (16 testes)

#### Cria√ß√£o de Artigo (4 testes)
- ‚úÖ Criar artigo com sucesso
- ‚úÖ Criar artigo com todas as propriedades opcionais
- ‚úÖ Criar artigo com tags (many-to-many)
- ‚úÖ Rejeitar slug duplicado (constraint √∫nico)

#### Leitura de Artigos (4 testes)
- ‚úÖ Buscar artigo por slug
- ‚úÖ Filtrar artigos por status
- ‚úÖ Buscar artigos com tags
- ‚úÖ Listar artigos ordenados por data de publica√ß√£o

#### Atualiza√ß√£o de Artigo (3 testes)
- ‚úÖ Atualizar conte√∫do do artigo
- ‚úÖ Alterar status de rascunho para publicado
- ‚úÖ Adicionar tags a artigo existente

#### Dele√ß√£o de Artigo (3 testes)
- ‚úÖ Deletar artigo
- ‚úÖ Deletar artigo e suas tags em cascade
- ‚úÖ Deletar artigo e seus favoritos em cascade

#### Favoritos de Artigos (3 testes)
- ‚úÖ Adicionar artigo aos favoritos
- ‚úÖ Rejeitar duplica√ß√£o de favorito (constraint √∫nico)
- ‚úÖ Listar artigos favoritados por usu√°rio

---

### 4. Testes de Relacionamentos e Cascades (15 testes)

#### Relacionamentos One-to-Many (3 testes)
- ‚úÖ Criar usu√°rio com m√∫ltiplos favoritos de produtos
- ‚úÖ Criar produto com m√∫ltiplas avalia√ß√µes
- ‚úÖ Criar produto com m√∫ltiplas imagens ordenadas

#### Relacionamentos Many-to-Many (3 testes)
- ‚úÖ Criar artigo com m√∫ltiplas tags
- ‚úÖ Buscar artigos por tag (rela√ß√£o inversa)
- ‚úÖ Permitir que uma tag seja usada em m√∫ltiplos artigos

#### Opera√ß√µes CASCADE - Dele√ß√£o (6 testes)
- ‚úÖ Deletar usu√°rio e todos os favoritos em cascade
- ‚úÖ Deletar usu√°rio e todas as avalia√ß√µes em cascade
- ‚úÖ Deletar produto e todas as imagens em cascade
- ‚úÖ Deletar produto e todas as avalia√ß√µes em cascade
- ‚úÖ Deletar artigo e todas as tags (ArtigoTag) em cascade
- ‚úÖ Verificar que tags n√£o s√£o deletadas (apenas ArtigoTag)

#### Constraints de Integridade Referencial (4 testes)
- ‚úÖ Rejeitar cria√ß√£o de produto com categoria inexistente
- ‚úÖ Rejeitar cria√ß√£o de usu√°rio com g√™nero inexistente
- ‚úÖ Rejeitar cria√ß√£o de favorito com usu√°rio inexistente
- ‚úÖ Rejeitar cria√ß√£o de avalia√ß√£o com produto inexistente

#### Transa√ß√µes Complexas (3 testes)
- ‚úÖ Criar usu√°rio, produto e favorito em transa√ß√£o at√¥mica
- ‚úÖ Fazer rollback completo ao falhar em transa√ß√£o complexa
- ‚úÖ Criar produto com imagens e avalia√ß√µes em transa√ß√£o

---

## ‚öôÔ∏è Configura√ß√£o

### 1. Vari√°veis de Ambiente

**Arquivo: `.env.test`**

```env
# Banco de dados de teste (schema separado)
DATABASE_URL="postgresql://user:password@host:port/database?schema=test"

# Credenciais de admin para testes
ADMIN_USERNAME=admin_test
ADMIN_PASSWORD=test_password_123

# JWT Secret para testes
JWT_SECRET=test_secret_key_for_integration_tests
```

**‚ö†Ô∏è IMPORTANTE:**
- Use um **schema separado** (ex: `?schema=test`) ou banco de dados dedicado para testes
- Nunca use o banco de dados de produ√ß√£o ou desenvolvimento
- Os testes **limpam todos os dados** antes e depois da execu√ß√£o

---

### 2. Setup do Banco de Dados de Teste

```bash
# Criar estrutura do banco de dados de teste
npm run test:integration:setup

# Este comando executa:
# 1. prisma db push --force-reset (cria/reseta schema)
# 2. Cria dados b√°sicos (g√™neros, categorias, tags, etc.)
```

---

## üîÑ Fluxo de Execu√ß√£o dos Testes

### 1. beforeAll (Setup Global)
```typescript
// tests/integration/setup.ts

beforeAll(async () => {
  await prisma.$connect();           // Conectar ao banco
  await limparBancoDeDados();        // Limpar todas as tabelas
  await criarDadosBasicos();         // Criar g√™neros, categorias, tags
});
```

### 2. afterEach (Limpeza Entre Testes)
```typescript
afterEach(async () => {
  // Limpar apenas dados de teste, manter dados b√°sicos
  await prisma.favoritoArtigo.deleteMany();
  await prisma.favorito.deleteMany();
  await prisma.avaliacao.deleteMany();
  await prisma.produto.deleteMany();
  await prisma.artigo.deleteMany();
  await prisma.usuario.deleteMany();
  // ... etc
});
```

### 3. afterAll (Teardown Global)
```typescript
afterAll(async () => {
  await limparBancoDeDados();        // Limpar tudo
  await prisma.$disconnect();        // Desconectar do banco
});
```

---

## üìù Exemplos de Testes

### Exemplo 1: Teste de Constraint √önico (Email)

```typescript
it('deve rejeitar cria√ß√£o de usu√°rio com email duplicado', async () => {
  const senhaHash = await bcrypt.hash('SenhaForte123!', 10);

  // Criar primeiro usu√°rio
  await prisma.usuario.create({
    data: {
      nome: 'Jo√£o Silva',
      email: 'joao@teste.com',
      senha: senhaHash,
      id_genero: 1,
    },
  });

  // Tentar criar segundo usu√°rio com mesmo email
  await expect(
    prisma.usuario.create({
      data: {
        nome: 'Maria Silva',
        email: 'joao@teste.com', // Email duplicado
        senha: senhaHash,
        id_genero: 2,
      },
    })
  ).rejects.toThrow(); // ‚úÖ Deve lan√ßar erro
});
```

---

### Exemplo 2: Teste de CASCADE Delete

```typescript
it('deve deletar produto e suas imagens em cascade', async () => {
  // Criar produto com imagens
  const produto = await prisma.produto.create({
    data: {
      nome: 'Produto com Imagens',
      marca: 'Marca Teste',
      preco: 30.00,
      id_categoria: 1,
      imagens: {
        create: [
          { url: 'https://exemplo.com/img1.jpg', ordem: 1 },
          { url: 'https://exemplo.com/img2.jpg', ordem: 2 },
        ],
      },
    },
  });

  // Deletar produto
  await prisma.produto.delete({
    where: { id: produto.id },
  });

  // Verificar que imagens foram deletadas em cascade
  const imagens = await prisma.imagemProduto.findMany({
    where: { id_produto: produto.id },
  });

  expect(imagens.length).toBe(0); // ‚úÖ Imagens deletadas
});
```

---

### Exemplo 3: Teste de Transa√ß√£o com Rollback

```typescript
it('deve fazer rollback de transa√ß√£o ao falhar', async () => {
  try {
    await prisma.$transaction(async (tx) => {
      // Criar usu√°rio (sucesso)
      await tx.usuario.create({
        data: {
          nome: 'Jo√£o Silva',
          email: 'joao@teste.com',
          senha: 'hash',
          id_genero: 1,
        },
      });

      // Tentar criar com email duplicado (vai falhar)
      await tx.usuario.create({
        data: {
          nome: 'Maria Silva',
          email: 'joao@teste.com', // Duplicado!
          senha: 'hash',
          id_genero: 2,
        },
      });
    });
  } catch (error) {
    // Esperado falhar
  }

  // Verificar que NENHUM usu√°rio foi criado (rollback)
  const usuarios = await prisma.usuario.findMany({
    where: { email: 'joao@teste.com' },
  });

  expect(usuarios.length).toBe(0); // ‚úÖ Rollback funcionou
});
```

---

### Exemplo 4: Teste de Relacionamento Many-to-Many

```typescript
it('deve criar artigo com m√∫ltiplas tags', async () => {
  const artigo = await prisma.artigo.create({
    data: {
      titulo: 'Guia de Hidrata√ß√£o',
      slug: 'guia-hidratacao',
      conteudo: 'Conte√∫do...',
      status: 'publicado',
      tags: {
        create: [
          { id_tag: 1 }, // Hidrata√ß√£o
          { id_tag: 2 }, // Nutri√ß√£o
          { id_tag: 4 }, // Vegano
        ],
      },
    },
    include: {
      tags: {
        include: {
          tag: true,
        },
      },
    },
  });

  expect(artigo.tags.length).toBe(3); // ‚úÖ 3 tags associadas
  expect(artigo.tags[0].tag.nome).toBe('Hidrata√ß√£o');
});
```

---

## üêõ Troubleshooting

### Erro: "Database connection failed"

```bash
# Verifique a conex√£o com o banco de teste
dotenv -e .env.test -- npx prisma db pull

# Se falhar, verifique as credenciais no .env.test
```

---

### Erro: "Table does not exist"

```bash
# Recriar schema do banco de teste
npm run test:integration:setup
```

---

### Erro: "Unique constraint violation"

```bash
# Limpar banco de dados manualmente
dotenv -e .env.test -- npx prisma db push --force-reset

# Ou rodar setup novamente
npm run test:integration:setup
```

---

### Testes Lentos

Os testes de integra√ß√£o s√£o naturalmente mais lentos que testes unit√°rios devido √†s opera√ß√µes de banco de dados.

**Otimiza√ß√µes:**
- ‚úÖ Usar `--runInBand` (j√° configurado) para execu√ß√£o sequencial
- ‚úÖ Limpar apenas dados necess√°rios entre testes
- ‚úÖ Usar transa√ß√µes quando poss√≠vel

**Tempo esperado:**
- Testes unit√°rios: ~2-5 segundos (145 testes)
- Testes de integra√ß√£o: ~30-60 segundos (68 testes)

---

## üìà Pr√≥ximos Passos

### Testes Adicionais Planejados

1. **Testes de Performance de Queries**
   - Medir tempo de queries complexas
   - Validar √≠ndices do banco de dados

2. **Testes de Concorr√™ncia**
   - M√∫ltiplos usu√°rios acessando simultaneamente
   - Race conditions

3. **Testes de Migra√ß√£o de Dados**
   - Validar migra√ß√µes do Prisma
   - Testar rollback de migra√ß√µes

4. **Testes de Backup e Restore**
   - Validar integridade ap√≥s backup
   - Testar restore de dados

---

## üìö Refer√™ncias

- [Documenta√ß√£o do Prisma - Testing](https://www.prisma.io/docs/guides/testing)
- [Jest Best Practices](https://jestjs.io/docs/getting-started)
- [Database Testing Patterns](https://martinfowler.com/articles/practical-test-pyramid.html)

---

**Desenvolvido com ‚ù§Ô∏è pela equipe Oasis**
